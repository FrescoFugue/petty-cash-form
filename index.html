<script>
  const itemsContainer = document.getElementById("itemsContainer");
  const totalAmountInput = document.getElementById("totalAmount");

  function addItem() {
    const row = document.createElement("div");
    row.className = "flex gap-2";

    row.innerHTML = `
      <input
        type="text"
        placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"
        class="flex-1 rounded-lg border border-slate-300 px-3 py-2"
      />
      <input
        type="number"
        placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"
        class="w-32 rounded-lg border border-slate-300 px-3 py-2 item-amount"
        oninput="calculateTotal()"
      />
      <button type="button" onclick="removeItem(this)">üóë</button>
    `;

    itemsContainer.appendChild(row);
  }

  function removeItem(btn) {
    btn.parentElement.remove();
    calculateTotal();
  }

  function calculateTotal() {
    let total = 0;
    document.querySelectorAll(".item-amount").forEach(input => {
      total += Number(input.value || 0);
    });
    totalAmountInput.value = total;
  }

  addItem();

  document.getElementById("pettyForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const items = [];
    itemsContainer.querySelectorAll("div").forEach(row => {
      const inputs = row.querySelectorAll("input");
      if (inputs[0].value && inputs[1].value) {
        items.push({
          name: inputs[0].value,
          amount: Number(inputs[1].value)
        });
      }
    });

    if (items.length === 0) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
      return;
    }

    const payload = {
      requester: e.target.requester.value,
      items,
      amount: totalAmountInput.value
    };

    try {
      const res = await fetch(
        "https://YOUR-BACKEND-URL/submit-petty-cash",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }
      );

      if (!res.ok) throw new Error();
      alert("‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      e.target.reset();
      itemsContainer.innerHTML = "";
      addItem();
      calculateTotal();
    } catch {
      alert("‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }
  });
</script>

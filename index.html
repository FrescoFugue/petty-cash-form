<script>
document.addEventListener("DOMContentLoaded", () => {
  const itemsContainer = document.getElementById("itemsContainer");
  const totalAmountInput = document.getElementById("totalAmount");
  const form = document.getElementById("pettyForm");

  if (!itemsContainer || !totalAmountInput || !form) {
    console.error("‚ùå Missing required elements");
    return;
  }

  function calculateTotal() {
    let total = 0;
    itemsContainer.querySelectorAll(".item-amount").forEach(input => {
      total += Number(input.value || 0);
    });
    totalAmountInput.value = total;
  }

  function addItem() {
    const row = document.createElement("div");
    row.className = "flex gap-2 items-center";

    row.innerHTML = `
      <input
        type="text"
        placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"
        class="flex-1 rounded-lg border border-slate-300 px-3 py-2"
      />
      <input
        type="number"
        placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"
        class="w-32 rounded-lg border border-slate-300 px-3 py-2 item-amount"
      />
      <button type="button" class="text-red-600">üóë</button>
    `;

    row.querySelector(".item-amount")
      .addEventListener("input", calculateTotal);

    row.querySelector("button")
      .addEventListener("click", () => {
        row.remove();
        calculateTotal();
      });

    itemsContainer.appendChild(row);
  }

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 1 ‡πÅ‡∏ñ‡∏ß
  addItem();

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const items = [];
    itemsContainer.querySelectorAll("div").forEach(row => {
      const inputs = row.querySelectorAll("input");
      if (inputs[0].value && inputs[1].value) {
        items.push({
          name: inputs[0].value,
          amount: Number(inputs[1].value)
        });
      }
    });

    if (items.length === 0) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
      return;
    }

    const payload = {
      requester: form.requester.value,
      items,
      amount: totalAmountInput.value
    };

    try {
      const res = await fetch(
        "https://YOUR-BACKEND-URL/submit-petty-cash",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }
      );

      if (!res.ok) throw new Error();

      alert("‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      form.reset();
      itemsContainer.innerHTML = "";
      addItem();
      calculateTotal();

    } catch {
      alert("‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }
  });
});
</script>
